## on KnowCluster
### mysql container
mkdir /mnt/knowtmp/mysql
docker run -d --restart=always --name p1_mysql -e MYSQL_ROOT_PASSWORD=KnowEnG -p 3306:3306 \
    -v /mnt/knowtmp/mysql:/var/lib/mysql mysql

### redis container
mkdir /mnt/knowtmp/redis
docker run -d --name p1_redis -p 6379:6379 -v /mnt/knowtmp/redis:/data \
   redis redis-server --appendonly yes --requirepass KnowEnG

### cloud9 container
docker run -d --privileged --restart=always --name project1_c9 -h project1_c9 -p 8181:8181 \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v /usr/bin/docker:/bin/docker \
    -v /mnt/fast/knoweng:/workspace/fast \
    -v /mnt/shared:/workspace/shared \
    -v /mnt/knowtmp:/workspace/knowtmp \
    cblatti3/p1_cloud9:0.1 --auth project1:knowdev249

### update /etc/hosts
echo -e '192.17.176.156\tknowcluster01.dyndns.org\tknowcluster01' >> /etc/hosts

### copy pipeline code
cd /workspace/knowtmp/project1/
git clone https://github.com/KnowEnG/KnowNet_Pipeline.git
cd /workspace/fast/apps/
git clone https://github.com/KnowEnG/KnowNet_Pipeline.git




### Test local mode
### set environment vars
KNP_LOCAL_DIR='/workspace/apps/KnowNet_Pipeline'
KNP_CLOUD_DIR='/workspace/apps/KnowNet_Pipeline'
KNP_DATA_PATH='data_local_pipe'
KNP_LOGS_PATH='logs_local_pipe'
KNP_MYSQL_HOST='knowcharles.dyndns.org'
KNP_REDIS_HOST='knowcharles.dyndns.org'
KNP_CHRONOS_URL='LOCAL'

### reset everything
#### clear out mysql
KNP_CMD="mysql -h $KNP_MYSQL_HOST --port 3306 -uroot -pKnowEnG KnowNet \
    --execute \"drop database KnowNet;\""
echo $KNP_CMD

#### clear out redis
KNP_CMD="redis-cli -h $KNP_REDIS_HOST -a KnowEnG FLUSHDB"
echo $KNP_CMD

#### clear files
rm -r $KNP_LOGS_PATH/
rm -r $KNP_DATA_PATH/kegg
rm -r $KNP_DATA_PATH/dip

### run pipeline
#### setup utilities
KNP_CMD="python3 code/workflow_utilities.py CHECK -su \
    -myh $KNP_MYSQL_HOST -rh $KNP_REDIS_HOST \
    -ld $KNP_LOCAL_DIR -dp $KNP_DATA_PATH -lp $KNP_LOGS_PATH \
    -c $KNP_CHRONOS_URL -cd $KNP_CLOUD_DIR"
echo $KNP_CMD
#### crude timing: 1 hr 18 min
./code/reports/enumerate_files.sh $KNP_DATA_PATH COUNTS $KNP_MYSQL_HOST \
    $KNP_REDIS_HOST > tests/KN03build.pipe.local.setup

#### pipeline utilities with small sources
KNP_CMD="python3 code/workflow_utilities.py CHECK \
    -myh $KNP_MYSQL_HOST -rh $KNP_REDIS_HOST \
    -ld $KNP_LOCAL_DIR -dp $KNP_DATA_PATH -lp $KNP_LOGS_PATH \
    -c $KNP_CHRONOS_URL -cd $KNP_CLOUD_DIR -p kegg,,dip"
echo $KNP_CMD
#### crude timing: seconds
./code/reports/enumerate_files.sh $KNP_DATA_PATH COUNTS $KNP_MYSQL_HOST \
    $KNP_REDIS_HOST > tests/KN03build.pipe.local.2small




### Test docker mode
### set environment vars
KNP_LOCAL_DIR='/workspace/apps/KnowNet_Pipeline'
KNP_CLOUD_DIR='/mnt/backup/post3/apps/KnowNet_Pipeline/'
KNP_DATA_PATH='data_docker_pipe'
KNP_LOGS_PATH='logs_docker_pipe'
KNP_MYSQL_HOST='knowcorey.dyndns.org'
KNP_MYSQL_PORT='3307'
KNP_REDIS_HOST='knowcorey.dyndns.org'
KNP_REDIS_PORT='6380'
KNP_CHRONOS_URL='DOCKER'

### reset everything
#### clear out mysql
KNP_CMD="mysql -h $KNP_MYSQL_HOST --port $KNP_MYSQL_PORT -uroot -pKnowEnG KnowNet \
    --execute \"drop database KnowNet;\""
echo $KNP_CMD

#### clear out redis
KNP_CMD="redis-cli -h $KNP_REDIS_HOST -p $KNP_REDIS_PORT -a KnowEnG FLUSHDB"
echo $KNP_CMD

#### clear files
rm -r $KNP_LOGS_PATH/
rm -r $KNP_DATA_PATH/kegg
rm -r $KNP_DATA_PATH/dip

### run pipeline
#### setup utilities
KNP_CMD="python3 code/workflow_utilities.py CHECK -su \
    -myh $KNP_MYSQL_HOST -myp $KNP_MYSQL_PORT -rh $KNP_REDIS_HOST \
    -rp $KNP_REDIS_PORT -ld $KNP_LOCAL_DIR -dp $KNP_DATA_PATH \
    -lp $KNP_LOGS_PATH -c $KNP_CHRONOS_URL -cd $KNP_CLOUD_DIR"
echo $KNP_CMD
#### crude timing: 1 hr 18 min
./code/reports/enumerate_files.sh $KNP_DATA_PATH COUNTS $KNP_MYSQL_HOST \
    $KNP_REDIS_HOST $KNP_MYSQL_PORT $KNP_REDIS_PORT > tests/KN03build.pipe.docker.setup

#### pipeline utilities with small sources
KNP_CMD="python3 code/workflow_utilities.py CHECK \
    -myh $KNP_MYSQL_HOST -myp $KNP_MYSQL_PORT -rh $KNP_REDIS_HOST \
    -rp $KNP_REDIS_PORT -ld $KNP_LOCAL_DIR -dp $KNP_DATA_PATH \
    -lp $KNP_LOGS_PATH -c $KNP_CHRONOS_URL -cd $KNP_CLOUD_DIR -p kegg,,dip"
echo $KNP_CMD
#### crude timing: seconds
./code/reports/enumerate_files.sh $KNP_DATA_PATH COUNTS $KNP_MYSQL_HOST \
    $KNP_REDIS_HOST $KNP_MYSQL_PORT $KNP_REDIS_PORT > tests/KN03build.pipe.docker.2small




### Test chronos mode
### set environment vars
KNP_LOCAL_DIR='/workspace/fast/apps/KnowNet_Pipeline'
KNP_CLOUD_DIR='/mnt/fast/knoweng/apps/KnowNet_Pipeline/'
KNP_DATA_PATH='data_chronos_pipe'
KNP_LOGS_PATH='logs_chronos_pipe'
KNP_MYSQL_HOST='knowcluster01.dyndns.org'
KNP_REDIS_HOST='knowcluster01.dyndns.org'
KNP_CHRONOS_URL='knowcluster01.dyndns.org:4400'

### reset everything
#### clear out mysql
KNP_CMD="mysql -h $KNP_MYSQL_HOST --port 3306 -uroot -pKnowEnG KnowNet \
    --execute \"drop database KnowNet;\""
echo $KNP_CMD

#### clear out redis
KNP_CMD="redis-cli -h $KNP_REDIS_HOST -a KnowEnG FLUSHDB"
echo $KNP_CMD

#### clear files
rm -r $KNP_LOGS_PATH/
rm -r $KNP_DATA_PATH/kegg
rm -r $KNP_DATA_PATH/dip

#### clear chronos queue
for c in 'knowcluster01.dyndns.org:4400' ; do
    curl -L -X GET $c/scheduler/jobs | sed 's#,#\n#g' | sed 's#\[##g' | grep name | sed 's#{"name":"##g' | sed 's#"##g' > /tmp/t.txt
    for s in 'map-' 'table-' 'check-' 'fetch-' 'setup' ; do
        echo $s
        for i in `grep "$s" /tmp/t.txt  `; do
            CMD="curl -L -X DELETE $c/scheduler/job/$i";
            echo "$CMD";
            eval "$CMD";
        done;
    done;
done;

### run pipeline
#### setup utilities
KNP_CMD="python3 code/workflow_utilities.py CHECK -su \
    -myh $KNP_MYSQL_HOST -rh $KNP_REDIS_HOST \
    -ld $KNP_LOCAL_DIR -dp $KNP_DATA_PATH -lp $KNP_LOGS_PATH \
    -c $KNP_CHRONOS_URL -cd $KNP_CLOUD_DIR"
echo $KNP_CMD
#### crude timing: mins
./code/reports/enumerate_files.sh $KNP_DATA_PATH COUNTS $KNP_MYSQL_HOST \
    $KNP_REDIS_HOST > tests/KN03build.pipe.chronos.setup

#### pipeline utilities with small sources
KNP_CMD="python3 code/workflow_utilities.py CHECK \
    -myh $KNP_MYSQL_HOST -rh $KNP_REDIS_HOST \
    -ld $KNP_LOCAL_DIR -dp $KNP_DATA_PATH -lp $KNP_LOGS_PATH \
    -c $KNP_CHRONOS_URL -cd $KNP_CLOUD_DIR -p kegg,,dip"
echo $KNP_CMD
#### crude timing: seconds
./code/reports/enumerate_files.sh $KNP_DATA_PATH COUNTS $KNP_MYSQL_HOST \
    $KNP_REDIS_HOST > tests/KN03build.pipe.chronos.2small







python3 code/setup_utilities.py CHECK --su \
    -myh knowcluster01.dyndns.org -rh knowcluster01.dyndns.org \
    -ld /workspace/knowtmp/project1/KnowNet_Pipeline \
    -dp data_docker_pipe -lp logs_docker_pipe \
    -c DOCKER \
    -cd /mnt/knowtmp/project1/KnowNet_Pipeline

python3 code/setup_utilities.py CHECK \
    -myh knowcluster01.dyndns.org -rh knowcluster01.dyndns.org \
    -ld /workspace/knowtmp/project1/KnowNet_Pipeline \
    -dp data_docker_pipe -lp logs_docker_pipe \
    -c DOCKER \
    -cd /mnt/knowtmp/project1/KnowNet_Pipeline





    # neo4j containers
docker run -t --restart=always --name hdfs sequenceiq/hadoop-docker:latest /etc/bootstrap.sh -bash #ctrl+C to detach
docker run -d --restart=always --name mazerunner --link hdfs:hdfs kbastani/neo4j-graph-analytics:latest
docker run -t --restart=always --name p1_neo4j -p 7474:7474 \
    --link mazerunner:mazerunner --link hdfs:hdfs \
    -v /mnt/storage/project1/KnowNet_0.2/project1/p1neo4j/data:/opt/data \
    -v /mnt/storage/project1/KnowNet_0.2:/shared \
    kbastani/docker-neo4j #ctrl+C to detach
